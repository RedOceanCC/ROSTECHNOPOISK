# Руководство по развертыванию рефакторированного Telegram-бота

## Обзор изменений

### ✅ Реализованные улучшения:

1. **Полный рефакторинг процесса подачи заявки:**
   - Усиленная валидация входных данных
   - Проверка партнерских отношений между компаниями
   - Контроль статусов аукционов и техники
   - Улучшенная обработка ошибок с информативными сообщениями

2. **Оптимизация системы уведомлений:**
   - Разделение логики отправки уведомлений конкретным владельцам
   - Добавлена статистика доставки сообщений
   - Интеграция с NotificationService для сохранения в базе
   - Улучшенное форматирование сообщений с ограничением длины

3. **Расширенная обработка ошибок:**
   - Новые классы ошибок для Telegram API и ограничений скорости
   - Централизованное логирование с контекстом
   - Стандартизированные ответы API

4. **Миграции базы данных:**
   - Добавлен тип уведомления `new_bid`
   - Создана таблица `request_declines` для отслеживания отклонений

## Инструкция по развертыванию

### 1. Подготовка к обновлению

```bash
# Остановите текущий сервис
pm2 stop ростехнопоиск-backend

# Создайте резервную копию базы данных
cp backend/database/ростехнопоиск.db backend/database/ростехнопоиск.db.backup.$(date +%Y%m%d_%H%M%S)

# Создайте резервную копию текущего кода
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz backend/ telegram-webapp/
```

### 2. Обновление кода

```bash
# Замените старый telegram-bot.js на оптимизированную версию
mv backend/telegram-bot.js backend/telegram-bot.js.backup
mv backend/telegram-bot-optimized.js backend/telegram-bot.js

# Добавьте новые файлы обработки ошибок
cp backend/utils/errors-enhanced.js backend/utils/errors.js

# Проверьте, что все файлы на месте
ls -la backend/telegram-bot.js
ls -la backend/utils/errors.js
ls -la telegram-webapp/request.html
```

### 3. Выполнение миграций базы данных

```bash
cd backend

# Выполните миграции (автоматически применятся при запуске сервера)
# Или выполните вручную:
sqlite3 database/ростехнопоиск.db < database/migrations/20250120180000_add_new_bid_notification_type.sql
sqlite3 database/ростехнопоиск.db < database/migrations/20250120180100_create_request_declines_table.sql
```

### 4. Проверка конфигурации

Убедитесь, что переменные окружения настроены корректно:

```bash
# Проверьте .env файл
cat production.env | grep -E "(TELEGRAM_BOT_TOKEN|WEB_APP_URL)"

# Должны быть установлены:
# TELEGRAM_BOT_TOKEN=ваш_токен_бота
# WEB_APP_URL=https://ваш-домен.com (без слэша в конце)
```

### 5. Запуск обновленного сервиса

```bash
# Запустите сервис
pm2 start ecosystem.config.js

# Проверьте статус
pm2 status
pm2 logs ростехнопоиск-backend --lines 50
```

### 6. Проверка работоспособности

#### Автоматическая проверка:
```bash
# Запустите системную проверку
node system-check.js

# Проверьте API здоровья
curl -X GET http://localhost:3001/api/health
```

#### Ручная проверка:

1. **Проверка Telegram бота:**
   - Отправьте `/start` в бот
   - Отправьте `/menu` в бот
   - Убедитесь, что бот отвечает без ошибок

2. **Проверка создания заявки:**
   - Войдите в систему как менеджер
   - Создайте тестовую заявку
   - Проверьте, что владельцы получили уведомления

3. **Проверка WebApp:**
   - Нажмите "Подать заявку" в уведомлении
   - Убедитесь, что WebApp открывается корректно
   - Попробуйте подать тестовую ставку

4. **Проверка базы данных:**
```sql
-- Проверьте новые таблицы и типы
.schema notifications
.schema request_declines

-- Проверьте типы уведомлений
SELECT DISTINCT type FROM notifications;
```

### 7. Мониторинг после развертывания

#### В первые 24 часа следите за:

```bash
# Логи сервера
pm2 logs ростехнопоиск-backend --lines 100 -f

# Ошибки Telegram бота
grep -i "telegram.*error" logs/*.log

# Производительность базы данных
sqlite3 database/ростехнопоиск.db "PRAGMA integrity_check;"
```

#### Ключевые метрики:
- Количество отправленных уведомлений: `SELECT COUNT(*) FROM notifications WHERE created_at > datetime('now', '-1 day');`
- Ошибки доставки Telegram: `SELECT COUNT(*) FROM notifications WHERE telegram_sent = 0 AND created_at > datetime('now', '-1 day');`
- Активность ставок: `SELECT COUNT(*) FROM rental_bids WHERE created_at > datetime('now', '-1 day');`

## Откат изменений (при необходимости)

```bash
# Остановите сервис
pm2 stop ростехнопоиск-backend

# Восстановите резервную копию кода
mv backend/telegram-bot.js backend/telegram-bot-new.js
mv backend/telegram-bot.js.backup backend/telegram-bot.js

# Восстановите базу данных (только если есть критические проблемы)
cp backend/database/ростехнопоиск.db.backup.YYYYMMDD_HHMMSS backend/database/ростехнопоиск.db

# Запустите сервис
pm2 start ecosystem.config.js
```

## Основные улучшения в коде

### 1. Усиленная валидация API запросов:
- Проверка партнерских отношений
- Валидация статусов аукционов
- Контроль дедлайнов
- Проверка принадлежности техники

### 2. Оптимизированная отправка уведомлений:
- Разделение на методы для лучшей читаемости
- Подсчет успешных/неудачных отправок
- Сокращение длинных сообщений
- Сохранение статистики в базе

### 3. Улучшенная обработка ошибок:
- Специализированные классы ошибок
- Централизованное логирование
- Информативные сообщения для пользователей
- Контекстная информация для отладки

### 4. Дополнительные таблицы:
- `request_declines` - отслеживание отклонений заявок
- Расширенные типы уведомлений

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи: `pm2 logs`
2. Убедитесь в работоспособности БД: `node system-check.js`
3. Проверьте Telegram API: отправьте тестовое сообщение
4. При критических ошибках выполните откат согласно инструкции выше

**Важно:** После развертывания обязательно протестируйте полный цикл: создание заявки → получение уведомления → подача ставки → обработка результата.
