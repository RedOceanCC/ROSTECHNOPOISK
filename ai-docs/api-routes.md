# API маршруты РОСТЕХНОПОИСК

## Базовая информация

**Base URL:** `/api`  
**Аутентификация:** Session-based (cookie)  
**Формат ответа:** JSON

### Структура ответов

**Успешный ответ:**
```json
{
  "success": true,
  "data": "...",
  "message": "Описание операции"
}
```

**Ошибка:**
```json
{
  "success": false,
  "message": "Описание ошибки",
  "field": "поле_с_ошибкой"
}
```

## Аутентификация `/api/auth`

### `POST /api/auth/login`
Авторизация пользователя в системе.

**Тело запроса:**
```json
{
  "password": "строка"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Авторизация успешна",
  "user": {
    "id": 1,
    "name": "Иван Иванов",
    "role": "admin|owner|manager",
    "phone": "+7 900 123-45-67",
    "company_id": 1,
    "company_name": "ООО Компания"
  }
}
```

### `POST /api/auth/logout`
Выход из системы.

**Ответ:**
```json
{
  "success": true,
  "message": "Выход выполнен успешно"
}
```

### `GET /api/auth/me`
Получение информации о текущем пользователе.

**Ответ:** Объект пользователя или ошибка 401.

### `POST /api/auth/check-session`
Проверка активности сессии.

**Ответ:**
```json
{
  "success": true,
  "authenticated": true,
  "user": { /* объект пользователя */ }
}
```

## Управление пользователями `/api/users`

**Требования:** Авторизация обязательна для всех маршрутов.

### `GET /api/users`
Получить список всех пользователей. **Только админ.**

**Ответ:**
```json
{
  "success": true,
  "users": [
    {
      "id": 1,
      "name": "Имя",
      "role": "admin|owner|manager",
      "company_name": "Название компании",
      "phone": "+7 900 123-45-67"
    }
  ]
}
```

### `GET /api/users/:id`
Получить пользователя по ID. Доступно владельцу аккаунта или админу.

### `POST /api/users`
Создать пользователя. **Только админ.**

**Тело запроса:**
```json
{
  "name": "Имя пользователя",
  "role": "admin|owner|manager",
  "password": "пароль",
  "phone": "+7 900 123-45-67",
  "company_id": 1
}
```

### `PUT /api/users/:id`
Обновить пользователя. Доступно владельцу аккаунта или админу.

### `PUT /api/users/:id/password`
Изменить пароль пользователя.

**Тело запроса:**
```json
{
  "newPassword": "новый_пароль"
}
```

### `DELETE /api/users/:id`
Удалить пользователя. **Только админ.** Нельзя удалить самого себя.

### `GET /api/users/role/:role`
Получить пользователей по роли. **Только админ.**

### `POST /api/users/:id/link-telegram`
Привязать Telegram ID к пользователю.

**Тело запроса:**
```json
{
  "telegram_id": "@username или ID"
}
```

## Управление компаниями `/api/companies`

### `GET /api/companies`
Получить список всех компаний.

**Ответ:**
```json
{
  "success": true,
  "companies": [
    {
      "id": 1,
      "name": "ООО Компания",
      "description": "Описание",
      "contact_info": "Контакты",
      "status": "active|inactive"
    }
  ]
}
```

### `GET /api/companies/:id`
Получить компанию по ID.

### `POST /api/companies`
Создать компанию. **Только админ.**

**Тело запроса:**
```json
{
  "name": "Название компании",
  "description": "Описание (опционально)",
  "contact_info": "Контакты (опционально)"
}
```

### `PUT /api/companies/:id`
Обновить компанию. **Только админ.**

### `DELETE /api/companies/:id`
Удалить компанию. **Только админ.**

### `GET /api/companies/:id/partnerships`
Получить партнерства компании. Доступно админу или сотрудникам компании.

### `GET /api/companies/admin/partnerships`
Получить все партнерства. **Только админ.**

### `POST /api/companies/admin/partnerships`
Создать партнерство между компаниями. **Только админ.**

**Тело запроса:**
```json
{
  "owner_company_id": 1,
  "manager_company_id": 2
}
```

### `DELETE /api/companies/admin/partnerships/:id`
Удалить партнерство. **Только админ.**

## Управление техникой `/api/equipment`

### `GET /api/equipment/equipment-types`
Получить типы техники из базы данных. **Без авторизации.**

**Ответ:**
```json
{
  "success": true,
  "data": {
    "Самосвал": [
      {
        "subtype": "3-осный (6x4)",
        "characteristics": "Грузоподъёмность: 15–20 т",
        "is_off_road": false
      }
    ]
  }
}
```

### `GET /api/equipment`
Получить список техники в зависимости от роли:
- **Админ:** вся техника
- **Владелец:** только своя техника  
- **Менеджер:** техника партнерских компаний

### `GET /api/equipment/types`
Получить доступные типы техники для менеджера. **Только менеджеры.**

### `GET /api/equipment/available`
Получить доступную технику по типу. **Только менеджеры.**

**Параметры запроса:**
- `type` - тип техники
- `subtype` - подтип техники

### `GET /api/equipment/:id`
Получить технику по ID. Доступно владельцу или админу.

### `POST /api/equipment`
Добавить технику. **Только владельцы.**

**Тело запроса:**
```json
{
  "name": "Название техники",
  "type": "Тип техники",
  "subtype": "Подтип",
  "phone": "+7 900 123-45-67",
  "license_plate": "А123БВ777",
  "is_off_road": false,
  "description": "Описание",
  "location": "Местоположение",
  "hourly_rate": 1500.00,
  "daily_rate": 12000.00
}
```

### `PUT /api/equipment/:id`
Обновить технику. Доступно владельцу или админу.

### `PATCH /api/equipment/:id/status`
Обновить статус техники. **Только админ.**

**Тело запроса:**
```json
{
  "status": "available|busy|maintenance"
}
```

### `DELETE /api/equipment/:id`
Удалить технику. Доступно владельцу или админу. Нельзя удалить занятую технику.

## Заявки на аренду `/api/requests`

### `GET /api/requests`
Получить заявки в зависимости от роли:
- **Админ:** все заявки
- **Менеджер:** только свои заявки
- **Владелец:** активные заявки для участия

### `GET /api/requests/:id`
Получить заявку по ID с ставками (доступ зависит от роли и статуса аукциона).

### `POST /api/requests`
Создать заявку. **Только менеджеры.**

**Тело запроса:**
```json
{
  "equipment_type": "Тип техники",
  "equipment_subtype": "Подтип",
  "start_date": "2024-01-15",
  "end_date": "2024-01-20",
  "work_description": "Описание работ",
  "location": "Местоположение",
  "budget_range": "Бюджет (опционально)"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Заявка создана успешно. Аукцион начался!",
  "request": { /* объект заявки */ },
  "available_owners": 5
}
```

### `DELETE /api/requests/:id`
Удалить заявку. Доступно создателю или админу. Нельзя удалить завершенную заявку.

### `PATCH /api/requests/:id/status`
Обновить статус заявки. **Только админ.**

**Тело запроса:**
```json
{
  "status": "pending|auction_active|auction_closed|completed|cancelled"
}
```

### `POST /api/requests/:id/close-auction`
Принудительно закрыть аукцион. **Только админ.**

## Ставки в аукционах `/api/bids`

### `GET /api/bids`
Получить ставки:
- **Админ:** все ставки (требуется параметр `request_id`)
- **Владелец:** только свои ставки

### `GET /api/bids/:id`
Получить ставку по ID. Доступно создателю или админу.

### `POST /api/bids`
Создать ставку. **Только владельцы.**

**Тело запроса:**
```json
{
  "request_id": 1,
  "equipment_id": 1,
  "hourly_rate": 1500.00,
  "daily_rate": 12000.00,
  "total_price": 60000.00,
  "comment": "Комментарий (опционально)"
}
```

### `PUT /api/bids/:id`
Обновить ставку. Доступно создателю.

### `DELETE /api/bids/:id`
Удалить ставку. Доступно создателю.

### `PATCH /api/bids/:id/status`
Обновить статус ставки. **Только админ.**

### `GET /api/bids/request/:requestId`
Получить ставки по заявке. Доступ зависит от роли и статуса аукциона.

## Telegram интеграция `/api/telegram`

### `POST /api/telegram/link`
Привязать Telegram ID к аккаунту.

**Тело запроса:**
```json
{
  "telegram_id": "@username или ID"
}
```

### `DELETE /api/telegram/unlink`
Отвязать Telegram ID от аккаунта.

### `GET /api/telegram/bot-status`
Проверить статус Telegram бота.

### `POST /api/telegram/test-notification`
Отправить тестовое уведомление в Telegram.

### `POST /api/telegram/webhook`
Webhook для обработки команд бота.

## Логирование `/api/logs`

### `POST /api/logs/client`
Отправить лог с клиентской стороны на сервер.

**Тело запроса:**
```json
{
  "level": "info|warn|error|debug",
  "message": "Сообщение лога",
  "context": { /* дополнительный контекст */ },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## Коды ошибок

- **400** - Некорректные данные запроса
- **401** - Не авторизован
- **403** - Доступ запрещен
- **404** - Ресурс не найден
- **409** - Конфликт (например, дублирование)
- **500** - Внутренняя ошибка сервера

## Ограничения доступа

### Роли пользователей

**Admin (Администратор):**
- Полный доступ ко всем данным
- Управление пользователями и компаниями
- Управление партнерствами
- Принудительное закрытие аукционов

**Owner (Владелец техники):**
- Управление своей техникой
- Участие в аукционах (подача ставок)
- Просмотр активных заявок

**Manager (Менеджер):**
- Создание заявок на аренду
- Просмотр своих заявок и результатов аукционов
- Доступ к технике партнерских компаний

### Система партнерств

Менеджеры могут создавать заявки только на технику компаний-партнеров. Партнерства настраиваются администратором через endpoints `/api/companies/admin/partnerships`.
